<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Finder</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            text-align: center;
        }

        h2 {
            color: #333;
            margin-top: 20px;
        }

        /* Button Styles */
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            transition: 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        /* Loader (spinner) styles */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Table */
        .table-container {
            max-width: 95%;
            margin: 20px auto;
            overflow-x: auto; /* Enables horizontal scrolling on small screens */
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px; /* Ensures table does not shrink too much */
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            white-space: nowrap; /* Prevents text from wrapping */
        }

        th {
            background-color: #007bff;
            color: white;
        }

        /* Highlight selected row */
        .highlight {
            background-color: #d9f1ff !important;
        }

        /* Mobile Adaptation */
        @media screen and (max-width: 768px) {
            button {
                width: 90%;
                font-size: 14px;
            }

            .table-container {
                width: 100%;
                padding: 5px;
            }

            table {
                font-size: 14px;
            }
        }
    </style>
    <script>
        let selectedAddresses = [];
        let maxWaypoints = 10;
        let userLocation = null;
        let glassShieldCoordinates = [45.34786, -73.69077];

        function getLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        document.getElementById("status").innerText = "Location obtained! Sending...";
                        document.getElementById("loader").style.display = "inline-block"; 
                        sendLocation(userLocation.latitude, userLocation.longitude);
                    },
                    function(error) {
                        document.getElementById("status").innerText = "Error getting location: " + error.message;
                    }
                );
            } else {
                document.getElementById("status").innerText = "Geolocation not supported by this browser.";
            }
        }

        function sendLocation(lat, lng) {
            let url = "https://script.google.com/macros/s/AKfycbwcFfPAA7pJJLy-pencEU30TqMY0Nz2DNVad6olZlfYga6qJCTPcKLR11CrUy7zwqoo/exec";
        
            let requestData = { latitude: lat, longitude: lng };
            
            fetch(url, {
                redirect: "follow",
                method: "POST",
                body: JSON.stringify(requestData),
                headers: {
                    "Content-Type": "text/plain;charset=utf-8",
                },
            })
            .then(response => response.json())
            .then(data => displayResults(data))
            .catch(error => console.error("Fetch Error:", error));
        }

        function displayResults(data) {
            let resultDiv = document.getElementById("results");
            resultDiv.innerHTML = "";
            document.getElementById("loader").style.display = "none";

            if (data.error) {
                resultDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                return;
            }

            if (data.length === 0) {
                resultDiv.innerHTML = "<p>No locations found.</p>";
                return;
            }

            let tableContainer = document.createElement("div");
            tableContainer.classList.add("table-container");

            let table = document.createElement("table");

            let thead = document.createElement("thead");
            let headerRow = document.createElement("tr");
            let headers = ["Select", "Name", "Address", "Distance", "Travel Time"];
            
            headers.forEach(text => {
                let th = document.createElement("th");
                th.textContent = text;
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            let tbody = document.createElement("tbody");

            data.forEach(entry => {
                let row = document.createElement("tr");

                let checkboxCell = document.createElement("td");
                let checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.addEventListener("change", function() {
                    toggleSelection(row, entry.address, this);
                });

                checkboxCell.appendChild(checkbox);
                row.appendChild(checkboxCell);

                let nameCell = document.createElement("td");
                nameCell.textContent = entry.name;
                row.appendChild(nameCell);

                let addressCell = document.createElement("td");
                addressCell.textContent = entry.address;
                row.appendChild(addressCell);

                let distanceCell = document.createElement("td");
                distanceCell.textContent = entry.distance;
                row.appendChild(distanceCell);

                let travelTimeCell = document.createElement("td");
                travelTimeCell.textContent = entry.travel_time;
                row.appendChild(travelTimeCell);

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);
            resultDiv.appendChild(tableContainer);
            document.getElementById("status").innerText = "Results received!";
        }

        function toggleSelection(row, address, checkbox) {
            if (checkbox.checked) {
                if (selectedAddresses.length < maxWaypoints) {
                    selectedAddresses.push(address);
                    row.classList.add("highlight");
                } else {
                    checkbox.checked = false;
                    alert(`You can select up to ${maxWaypoints} waypoints.`);
                }
            } else {
                let index = selectedAddresses.indexOf(address);
                if (index > -1) {
                    selectedAddresses.splice(index, 1);
                }
                row.classList.remove("highlight");
            }
        }

        function generateRoute() {
            if (!userLocation) {
                alert("Please get your location first.");
                return;
            }

            if (selectedAddresses.length === 0) {
                alert("Please select at least one waypoint.");
                return;
            }

            let origin = `${userLocation.latitude},${userLocation.longitude}`;
            let destination = `${glassShieldCoordinates[0]},${glassShieldCoordinates[1]}`;
            let waypoints = selectedAddresses.map(encodeURIComponent).join("|");

            let mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypoints}&optimize=true`;

            window.open(mapsUrl, "_blank");
        }
    </script>
</head>
<body>
    <h2>Find Nearby Locations</h2>
    <button onclick="getLocation()">Get My Location</button>
    <button onclick="generateRoute()">Find Best Route</button>
    <p id="status">Click the button to find locations.</p>
    <span id="loader" class="loader"></span>
    <div id="results"></div>
</body>
</html>

